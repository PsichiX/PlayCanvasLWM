!function(e){"use strict";var t=e.lwm={pc:e.pc},n={exports:t};t.HOOK_INTO_PLAYCANVAS=e.hasOwnProperty("LWM_HOOK_INTO_PLAYCANVAS")?e.LWM_HOOK_INTO_PLAYCANVAS:!0,function(e){e.using=function(e,t){if(!e)throw new Error("using | `instance` parameter is null!");if(!(e.destroy instanceof Function))throw new Error("using | `instance` parameter does not have `destroy` function!");if(!(t instanceof Function))throw new Error("using | `action` parameter is not a function!");var n;try{n=t(e)}finally{e.destroy()}return n},e.stringFromBytes=function(e){if(!Array.isArray(e))throw new Error("using | `bytes` parameter is not an array!");return String.fromCharCode.apply(null,e)},e.stringFromBuffer=function(e){if(!(e instanceof ArrayBuffer))throw new Error("using | `buffer` parameter is not type of ArrayBuffer!");var t,n,r,o=new Uint16Array(e),a="";for(t=0,n=o.length;n>t;t+=65535)r=65535,t+65535>n&&(r=n-t),a+=String.fromCharCode.apply(null,o.subarray(t,t+r));return a}}(n.exports),function(e){function t(){this.mesh=-1,this.node=-1}function n(){this.min=[],this.max=[]}function r(){this.aabb=new n,this.base=-1,this.count=-1,this.type="",this.vertices=-1,this.indices=[]}function o(){this.name="",this.position=[],this.rotation=[],this.scale=[]}function a(){this.type="",this.components=-1,this.data=[]}function i(){this.position=new a,this.texCoord0=new a,this.normal=new a}function s(){this.version=-1,this.meshInstances=[],this.meshes=[],this.nodes=[],this.parents=[],this.skins=[],this.vertices=[]}function p(){this.model=new s}t.prototype=Object.create(null),t.prototype.mesh=-1,t.prototype.node=-1,n.prototype=Object.create(null),n.prototype.min=null,n.prototype.max=null,r.AABB=n,r.prototype=Object.create(null),r.prototype.aabb=null,r.prototype.base=-1,r.prototype.count=-1,r.prototype.type=null,r.prototype.vertices=-1,r.prototype.indices=null,o.prototype=Object.create(null),o.prototype.name=null,o.prototype.position=null,o.prototype.rotation=null,o.prototype.scale=null,a.prototype=Object.create(null),a.prototype.type=null,a.prototype.components=-1,a.prototype.data=null,i.VertexData=a,i.prototype=Object.create(null),i.prototype.position=null,i.prototype.texCoord0=null,i.prototype.normal=null,s.MeshInstance=t,s.Mesh=r,s.Node=o,s.Vertex=i,s.prototype=Object.create(null),s.prototype.version=-1,s.prototype.meshInstances=null,s.prototype.meshes=null,s.prototype.nodes=null,s.prototype.parents=null,s.prototype.skins=null,s.prototype.vertices=null,p.ModelData=s,p.prototype=Object.create(null),p.prototype.model=null,e.ModelFileFormat=p}(n.exports),function(e){function t(e,t){if(!e)throw new Error("BinaryReader | `buffer` parameter cannot be null!");if(!(e instanceof ArrayBuffer))throw new Error("BinaryReader | `buffer` parameter is not type of ArrayBuffer!");this._data=new DataView(e),this._position=0,this._size=e.byteLength,this._useLittleEndian=!t}t.SEEK_MODE={BEGIN:0,END:1,CURRENT:2},t.prototype=Object.create(null),t.prototype._data=null,t.prototype._position=0,t.prototype._size=0,t.prototype._useLittleEndian=!1,Object.defineProperty(t.prototype,"position",{get:function(){return this._position}}),Object.defineProperty(t.prototype,"size",{get:function(){return this._size}}),t.prototype.destroy=function(){this._data=null,this._position=0,this._size=0},t.prototype.seek=function(e,n){var r=this._position,o=this._size;e===t.SEEK_MODE.BEGIN?this._position=Math.max(0,Math.min(o,n)):e===t.SEEK_MODE.END?this._position=Math.max(0,Math.min(o,o-n)):e===t.SEEK_MODE.CURRENT&&(this._position=Math.max(0,Math.min(o,r+n)))},t.prototype.readBytes=function(e){var t,n=this._data,r=this._position,o=this._size,a=this._useLittleEndian,i=[];if(!n)throw new Error("BinaryReader::readBytes | instance is not initialized!");if(0>e)throw new Error("BinaryReader::readBytes | `count` parameter is less than 0!");if(r+e>o)throw new Error("BinaryReader::readBytes | there is no more space to read from!");for(t=0;e>t;++t)i.push(n.getInt8(r+t,a));return this._position+=e,i},t.prototype.readByte=function(){var e,t=this._data,n=this._position,r=this._size,o=this._useLittleEndian;if(!t)throw new Error("BinaryReader::readByte | instance is not initialized!");if(n+1>r)throw new Error("BinaryReader::readByte | there is no more space to read from!");return e=t.getInt8(n,o),this._position++,e},t.prototype.readInt32=function(){var e,t=this._data,n=this._position,r=this._size,o=this._useLittleEndian;if(!t)throw new Error("BinaryReader::readInt32 | instance is not initialized!");if(n+4>r)throw new Error("BinaryReader::readInt32 | there is no more space to read from!");return e=t.getInt32(n,o),this._position+=4,e},t.prototype.readUint32=function(){var e,t=this._data,n=this._position,r=this._size,o=this._useLittleEndian;if(!t)throw new Error("BinaryReader::readUint32 | instance is not initialized!");if(n+4>r)throw new Error("BinaryReader::readUint32 | there is no more space to read from!");return e=t.getUint32(n,o),this._position+=4,e},t.prototype.readSingle=function(){var e,t=this._data,n=this._position,r=this._size,o=this._useLittleEndian;if(!t)throw new Error("BinaryReader::readSingle | instance is not initialized!");if(n+4>r)throw new Error("BinaryReader::readSingle | there is no more space to read from!");return e=t.getFloat32(n,o),this._position+=4,e},e.BinaryReader=t}(n.exports),function(e){function t(){}var n=e.using,r=e.stringFromBytes,o=e.BinaryReader,a=e.ModelFileFormat,i={NONE:0,SMALL_SIZE_OF_PACKED_DATA:1};t.isHeaderValid=function(e){if(!(e instanceof ArrayBuffer))throw new Error("Serializer::unpack | `buffer` parameter is not type of ArrayBuffer!");return n(new o(e),function(e){var t=e.readBytes(4);return t[0]==="L".charCodeAt(0)&&t[1]==="W".charCodeAt(0)&&t[2]==="M".charCodeAt(0)&&0===t[3]})},t.prototype=Object.create(null),t.prototype.unpack=function(e){if(!(e instanceof ArrayBuffer))throw new Error("Serializer::unpack | `buffer` parameter is not type of ArrayBuffer!");return n(new o(e),function(e){var t,n,o,s,p,l,u,d,c,h,f,y,m,_,w,g,E,S,A,M,B,k,I,C,O,v,L,D,b,z=new a,x=z.model,N=0,T=0,P=0,H=0,R=0;if(t=e.readBytes(4),t[0]!=="L".charCodeAt(0)||t[1]!=="W".charCodeAt(0)||t[2]!=="M".charCodeAt(0)||0!==t[3])throw new Error("Serializer::unpack | wrong header signature!");if(n=e.readByte(),x=z.model,x.version=e.readByte(),n===i.NONE?(N=e.readInt32(),T=e.readInt32(),P=e.readInt32(),H=e.readInt32(),R=e.readInt32()):n===i.SMALL_SIZE_OF_PACKED_DATA&&(o=this.unpackIntsQuantized(e),N=o[0],T=o[1],P=o[2],H=o[3],R=o[4]),N>0)if(n===i.NONE)for(C=0;N>C;++C)s=new a.ModelData.MeshInstance,s.mesh=e.readInt32(),s.node=e.readInt32(),x.meshInstances.push(s);else if(n===i.SMALL_SIZE_OF_PACKED_DATA){if(o=this.unpackIntsQuantized(e),o.length!==2*N)throw new Error("Serializer::unpack | mesh instances count does not match unpacked items count!");for(C=0,O=0;N>C;++C)s=new a.ModelData.MeshInstance,s.mesh=o[O++],s.node=o[O++],x.meshInstances.push(s)}if(T>0)if(n===i.NONE)for(C=0;T>C;++C){for(p=new a.ModelData.Mesh,c=e.readByte(),h=e.readBytes(c),p.type=r(h),p.base=e.readInt32(),p.count=e.readInt32(),p.vertices=e.readInt32(),f=new a.ModelData.Mesh.AABB,f.min.push(e.readSingle()),f.min.push(e.readSingle()),f.min.push(e.readSingle()),f.max.push(e.readSingle()),f.max.push(e.readSingle()),f.max.push(e.readSingle()),p.aabb=f,O=0;O<p.count;++O)p.indices.push(e.readUint32());x.meshes.push(p)}else if(n===i.SMALL_SIZE_OF_PACKED_DATA){if(y=this.unpackStringsQuantized(e),y.length!==T)throw new Error("Serializer::unpack | meshes count does not match unpacked items count!");if(m=this.unpackIntsQuantized(e),m.length!==3*T)throw new Error("Serializer::unpack | meshes count does not match unpacked items count!");for(C=0,O=0,v=0;T>C;++C){p=new a.ModelData.Mesh,p.type=y[O++],p.base=m[v++],p.count=m[v++],p.vertices=m[v++],f=new a.ModelData.Mesh.AABB,f.min.push(e.readSingle()),f.min.push(e.readSingle()),f.min.push(e.readSingle()),f.max.push(e.readSingle()),f.max.push(e.readSingle()),f.max.push(e.readSingle()),p.aabb=f;var U=this.unpackUintsQuantized(e);if(U.length!==p.count)throw new Error("Serializer::unpack | mesh "+C+" indices count does not match unpacked items count!");for(l=0;l<p.count;++l)p.indices.push(U[l]);x.meshes.push(p)}}if(P>0)if(n===i.NONE)for(C=0;P>C;++C)l=new a.ModelData.Node,u=e.readByte(),d=e.readBytes(u),l.name=r(d),l.position.push(e.readSingle()),l.position.push(e.readSingle()),l.position.push(e.readSingle()),l.rotation.push(e.readSingle()),l.rotation.push(e.readSingle()),l.rotation.push(e.readSingle()),l.scale.push(e.readSingle()),l.scale.push(e.readSingle()),l.scale.push(e.readSingle()),x.nodes.push(l);else if(n===i.SMALL_SIZE_OF_PACKED_DATA){if(o=this.unpackStringsQuantized(e),o.length!==P)throw new Error("Serializer::unpack | nodes count does not match unpacked items count!");for(C=0;P>C;++C)l=new a.ModelData.Node,l.name=o[C],l.position.push(e.readSingle()),l.position.push(e.readSingle()),l.position.push(e.readSingle()),l.rotation.push(e.readSingle()),l.rotation.push(e.readSingle()),l.rotation.push(e.readSingle()),l.scale.push(e.readSingle()),l.scale.push(e.readSingle()),l.scale.push(e.readSingle()),x.nodes.push(l)}if(H>0)if(n===i.NONE)for(C=0;H>C;++C)x.parents.push(e.readInt32());else if(n===i.SMALL_SIZE_OF_PACKED_DATA){if(o=this.unpackIntsQuantized(e),o.length!==H)throw new Error("Serializer::unpack | parents count does not match unpacked items count!");for(C=0;H>C;++C)x.parents.push(o[C])}if(R>0)if(n===i.NONE)for(C=0;R>C;++C){for(_=new a.ModelData.Vertex,w=new a.ModelData.Vertex.VertexData,c=e.readByte(),h=e.readBytes(c),w.type=r(h),w.components=e.readInt32(),g=e.readInt32(),O=0;g>O;++O)w.data.push(e.readSingle());for(_.position=w,w=new a.ModelData.Vertex.VertexData,c=e.readByte(),h=e.readBytes(c),w.type=r(h),w.components=e.readInt32(),g=e.readInt32(),O=0;g>O;++O)w.data.push(e.readSingle());for(_.texCoord0=w,w=new a.ModelData.Vertex.VertexData,c=e.readByte(),h=e.readBytes(c),w.type=r(h),w.components=e.readInt32(),g=e.readInt32(),O=0;g>O;++O)w.data.push(e.readSingle());_.normal=w,x.vertices.push(_)}else if(n===i.SMALL_SIZE_OF_PACKED_DATA){if(y=this.unpackStringsQuantized(e),y.length!==3*R)throw new Error("Serializer::unpack | vertices count does not match unpacked items count!");if(E=this.unpackIntsQuantized(e),E.length!==3*R)throw new Error("Serializer::unpack | vertices count does not match unpacked items count!");var V=this.unpackIntsQuantized(e);if(V.length!==3*R)throw new Error("Serializer::unpack | vertices count does not match unpacked items count!");for(C=0,L=0,D=0,b=0;R>C;++C){for(_=new a.ModelData.Vertex,S=_.position,A=_.texCoord0,M=_.normal,S.type=y[L++],A.type=y[L++],M.type=y[L++],S.components=E[D++],A.components=E[D++],M.components=E[D++],B=V[b++],k=V[b++],I=V[b++],O=0;B>O;++O)S.data.push(e.readSingle());for(O=0;k>O;++O)A.data.push(e.readSingle());for(O=0;I>O;++O)M.data.push(e.readSingle());x.vertices.push(_)}}return z}.bind(this))},t.prototype.unpackUints=function(e){var t,n,r,a,i,s,p,l,u,d=e.readInt32(),c=e.readUint32(),h=e.readByte();if(0>=d)return null;if(t=new Array(d),0==h)for(u=0;d>u;++u)t[u]=c;else if(32>h){for(n=this.calculateBitsMask(h),r=0,a=0|e.readUint32(),i=0,s=0,p=0,l=0,u=0;d>u;++u)r=(a&n<<i)>>i&n,i+=h,i>=32&&(i-=32,s=h-i,p=this.calculateBitsMask(s),l=this.calculateBitsMask(i),a=e.readUint32()>>>0,r&=p,r|=(a&l)<<s),t[u]=((r&n)>>>0)+c;0==i&&e.seek(o.SEEK_MODE.CURRENT,-4)}else for(u=0;d>u;++u)t[u]=e.readUint32();return t},t.prototype.unpackInts=function(e){var t,n,r,a,i,s,p,l,u,d=e.readInt32(),c=e.readInt32(),h=e.readByte();if(0>=d)return null;if(t=new Array(d),0==h)for(u=0;d>u;++u)t[u]=c;else if(32>h){for(n=this.calculateBitsMask(h),r=0,a=0|e.readInt32(),i=0,s=0,p=0,l=0,u=0;d>u;++u)r=(a&n<<i)>>i&n,i+=h,i>=32&&(i-=32,s=h-i,p=this.calculateBitsMask(s),l=this.calculateBitsMask(i),a=e.readInt32()>>>0,r&=p,r|=(a&l)<<s),t[u]=((r&n)>>>0)+c;0==i&&e.seek(o.SEEK_MODE.CURRENT,-4)}else for(u=0;d>u;++u)t[u]=e.readInt32();return t},t.prototype.unpackStrings=function(e){var t,n,o,a,i=this.unpackInts(e),s=this.unpackInts(e),p=r(s),l=new Array(i.length);for(t=0,o=0,n=i.length;n>t;++t)a=i[t],l[t]=p.substring(o,o+a),o+=a;return l},t.prototype.unpackIntsQuantized=function(e){var t,n,r,o,a,i,s,p=e.readInt32();if(0>p)return this.unpackInts(e);for(t=e.readInt32(),n=new Array(t),o=0,s=0;p>o;++o)for(r=this.unpackInts(e),a=0,i=r.length;i>a;++a)n[s++]=r[a];return n},t.prototype.unpackUintsQuantized=function(e){var t,n,r,o,a,i,s,p=e.readInt32();if(0>p)return this.unpackUints(e);for(t=e.readInt32(),n=new Array(t),o=0,s=0;p>o;++o)for(r=this.unpackUints(e),a=0,i=r.length;i>a;++a)n[s++]=r[a];return n},t.prototype.unpackStringsQuantized=function(e){var t,n,r,o,a,i,s,p=e.readInt32();if(0>p)return this.unpackStrings(e);for(t=e.readInt32(),n=new Array(t),o=0,s=0;p>o;++o)for(r=this.unpackStrings(e),a=0,i=r.length;i>a;++a)n[s++]=r[a];return n},t.prototype.calculateBitsMask=function(e){return(1<<e)-1},e.Serializer=t}(n.exports),function(e){function t(e){this._device=e}if(e.HOOK_INTO_PLAYCANVAS&&e.pc){var n=e.pc,r=e.stringFromBuffer,o=e.Serializer;t.DEFAULT_MATERIAL=n.ModelHandler.DEFAULT_MATERIAL.clone(),t.prototype=Object.create(null),t.prototype._device=null,t.prototype.load=function(e,t){console.log("LWMModelHandler::load | ",e),n.net.http.get(e,function(e){t&&t(null,e)},{withCredentials:!1,responseType:"arraybuffer",error:function(r,o,a){t&&t(n.string.format("Error loading LWM model: {0} [status: {1}]",e,r))}})},t.prototype.open=function(e,t){var a,i,s;if(!(t instanceof ArrayBuffer))throw new Error("LWMModelHandler::open | `data` parameter is not type of ArrayBuffer!");return o.isHeaderValid(t)?(console.log("LWMModelHandler::open | LWM header found - unpack"),i=new o,a=i.unpack(t)):(console.log("LWMModelHandler::open | LWM header not found - parse as JSON string"),s=r(t),a=JSON.parse(s)),this.ensureVertices(a),n.ModelHandler.prototype.open.call(this,e,a)},t.prototype.patch=function(e,t){console.log("LWMModelHandler::patch | ",e.resource,e.data),n.ModelHandler.prototype.patch.call(this,e,t)},t.prototype.ensureVertices=function(e){var t,r,o,a,i,s,p,l,u=e.model,d=u?u.vertices:null;if(d)for(t=0,o=d.length;o>t;++t)if(a=d[t],i=a.position,s=a.texCoord0,p=a.normal,i&&s&&p){for(r=s.data.length,l=(n.data.length/n.components|0)*s.components;l>r;++r)s.data.push(0);for(r=p.data.length,l=(n.data.length/n.components|0)*p.components;l>r;++r)s.data.push(0)}},e.LWMModelHandler=t}}(n.exports),function(e){function t(e){this._pc=e}var n=e.LWMModelHandler;t.prototype=Object.create(null),t.prototype._pc=null,t.prototype._pc_http_isBinaryContentType=null,t.prototype.hook=function(){var e,t,r,o,a=this._pc,i=a?a.net:null,s=i?i.Http:null,p=i?i.http:null,l=a?a.Application:null;if(s&&(s.ContentType&&!s.ContentType.hasOwnProperty("LWM")&&(console.log("PlayCanvasHook::hook | add content type"),s.ContentType.LWM="application/octet-stream"),s.binaryExtensions&&s.binaryExtensions.indexOf(".lwm")<0&&(console.log("PlayCanvasHook::hook | add binary extension"),s.binaryExtensions.push(".lwm")),this._pc_http_isBinaryContentType||(console.log("PlayCanvasHook::hook | override ::isBinaryContentType"),this._pc_http_isBinaryContentType=s.prototype.isBinaryContentType,s.prototype.isBinaryContentType=function(e){var t=[s.ContentType.WAV,s.ContentType.OGG,s.ContentType.MP3,s.ContentType.BIN,s.ContentType.DDS,s.ContentType.LWM];return t.indexOf(e)>=0}),p&&(p.isBinaryContentType=s.prototype.isBinaryContentType)),l&&l._applications){console.log("PlayCanvasHook::hook | override model handler"),e=l._applications;for(o in e)e.hasOwnProperty(o)&&(t=e[o],t&&(r=t.loader,r&&r.addHandler("lwmmodel",new n(t.graphicsDevice))))}},e.PlayCanvasHook=t}(n.exports),t.HOOK_INTO_PLAYCANVAS&&(e.pc?new t.PlayCanvasHook(e.pc).hook():console.error("Cannot hook into PlayCanvas - there is no PlayCanvas namespace available to use!"))}(window);